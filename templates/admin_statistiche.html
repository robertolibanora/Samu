<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SAMU Admin">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SAMU">
    <link rel="manifest" href="/manifest-admin.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/static/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/static/icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="/static/icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
    <title>Statistiche - Admin</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/admin.css">
    <link rel="stylesheet" href="/static/ux-enhancements.css">
    <link rel="stylesheet" href="/static/pwa-enhancements.css">
    <script src="/static/pwa-init.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-container {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            height: 250px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
                padding: 20px;
            }
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .chart-title {
                font-size: 16px;
                margin-bottom: 15px;
            }
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        /* Padding per bottom-nav */
        .app-content {
            padding-bottom: 90px;
        }
    </style>
</head>
<body>
<div class="overlay">
    <div class="app-content">
    <h2>Statistiche</h2>

    {% if user_name %}
    <div class="user-badge">
        <span></span>
        <span>{{ user_name }}</span>
    </div>
    {% endif %}

    <!-- Grafico Fascia d'EtÃ  -->
    {% if eta_stats|length > 0 %}
    <div class="chart-container">
        <div class="chart-title">Distribuzione per Fascia d'EtÃ </div>
        <canvas id="etaChart"></canvas>
    </div>
    {% endif %}

    <!-- Grafico Orari di Arrivo -->
    {% if orario_stats|length > 0 %}
    <div class="chart-container">
        <div class="chart-title">Distribuzione Orari di Arrivo</div>
        <canvas id="orarioChart"></canvas>
    </div>
    {% endif %}

    <!-- Grafico Registrazioni per Evento -->
    {% if evento_stats|length > 0 %}
    <div class="chart-container">
        <div class="chart-title">Registrazioni per Evento</div>
        <canvas id="eventoChart"></canvas>
    </div>
    {% else %}
    <div class="no-results" style="margin-top: 20px;">
        <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“Š</div>
        Nessuna registrazione disponibile
    </div>
    {% endif %}

    <!-- Grafico Andamento Giornaliero -->
    {% if giornaliere_stats|length > 0 %}
    <div class="chart-container">
        <div class="chart-title">Andamento Ultimi 7 Giorni</div>
        <canvas id="giornaliereChart"></canvas>
    </div>
    {% endif %}

    {% if eta_stats|length == 0 and orario_stats|length == 0 %}
    <div class="no-results">
        <div style="font-size: 48px; margin-bottom: 10px;"></div>
        Nessun dato disponibile
    </div>
    {% endif %}
    </div>
</div>

<!-- Bottom Navigation Bar -->
<div class="bottom-nav">
    <a href="/admin/dashboard" class="nav-item">
        <span class="nav-icon"></span>
        <span class="nav-label">Dashboard</span>
    </a>
    <a href="/admin/statistiche" class="nav-item active">
        <span class="nav-icon"></span>
        <span class="nav-label">Statistiche</span>
    </a>
    <a href="/admin/evento/crea" class="nav-item">
        <span class="nav-icon"></span>
        <span class="nav-label">Nuovo</span>
    </a>
    <a href="/admin/eventi" class="nav-item">
        <span class="nav-icon"></span>
        <span class="nav-label">Eventi</span>
    </a>
</div>

<script>
// Configurazione colori
const colors = {
    primary: '#FFD700',
    secondary: '#FFA500',
    success: '#FFD700',
    accent: '#DAA520'
};

// Grafico Fascia d'EtÃ 
{% if eta_stats|length > 0 %}
const etaCtx = document.getElementById('etaChart').getContext('2d');
new Chart(etaCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for stat in eta_stats %}'{{ stat[0] }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for stat in eta_stats %}{{ stat[1] }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 215, 0, 0.8)',
                'rgba(255, 165, 0, 0.8)',
                'rgba(218, 165, 32, 0.8)',
                'rgba(184, 134, 11, 0.8)',
                'rgba(255, 193, 7, 0.8)'
            ],
            borderColor: '#FFD700',
            borderWidth: 2
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#fff',
                    padding: 10,
                    font: {
                        size: 11
                    }
                }
            }
        }
    }
});
{% endif %}

// Grafico Orari
{% if orario_stats|length > 0 %}
const orarioCtx = document.getElementById('orarioChart').getContext('2d');
new Chart(orarioCtx, {
    type: 'bar',
    data: {
        labels: [{% for stat in orario_stats %}'{{ stat[0] }}:00'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Registrazioni',
            data: [{% for stat in orario_stats %}{{ stat[1] }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: 'rgba(255, 215, 0, 0.6)',
            borderColor: '#FFD700',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    },
                    stepSize: 1,
                    precision: 0,
                    callback: function(value) {
                        if (Number.isInteger(value)) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            },
            x: {
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            }
        }
    }
});
{% endif %}

// Grafico Eventi - Registrazioni per Data Evento
{% if evento_stats|length > 0 %}
const eventoCtx = document.getElementById('eventoChart').getContext('2d');

// Dati grezzi dal backend
const rawEventDates = [{% for stat in evento_stats %}'{{ stat[0] }}'{% if not loop.last %},{% endif %}{% endfor %}];
const rawEventData = [{% for stat in evento_stats %}{{ stat[1] }}{% if not loop.last %},{% endif %}{% endfor %}];

// Formatta le date in formato DD/MM per le etichette
const formattedEventLabels = rawEventDates.map(dateStr => {
    if (!dateStr) return 'N/A';
    const [anno, mese, giorno] = dateStr.split('-');
    return `${giorno}/${mese}`;
});

new Chart(eventoCtx, {
    type: 'bar',
    data: {
        labels: formattedEventLabels,
        datasets: [{
            label: 'Persone registrate',
            data: rawEventData,
            backgroundColor: 'rgba(255, 215, 0, 0.7)',
            borderColor: '#FFD700',
            borderWidth: 2,
            borderRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: '#FFD700',
                bodyColor: '#fff',
                borderColor: '#FFD700',
                borderWidth: 1,
                padding: 12,
                displayColors: true,
                callbacks: {
                    title: function(context) {
                        const dataIndex = context[0].dataIndex;
                        const fullDate = rawEventDates[dataIndex];
                        if (!fullDate) return 'Data non disponibile';
                        const [anno, mese, giorno] = fullDate.split('-');
                        return `${giorno}/${mese}/${anno}`;
                    },
                    label: function(context) {
                        const value = context.parsed.y;
                        return `${value} ${value === 1 ? 'persona' : 'persone'}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    },
                    stepSize: 1,
                    precision: 0,
                    callback: function(value) {
                        // Mostra solo numeri interi
                        if (Number.isInteger(value)) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    lineWidth: 1
                }
            },
            x: {
                ticks: {
                    color: '#fff',
                    font: {
                        size: 10
                    },
                    maxRotation: 45,
                    minRotation: 0
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    display: false
                }
            }
        }
    }
});
{% endif %}

// Grafico Giornaliero
{% if giornaliere_stats|length > 0 %}
const giornaliereCtx = document.getElementById('giornaliereChart').getContext('2d');

// Dati grezzi dal backend
const rawDates = [{% for stat in giornaliere_stats %}'{{ stat[0] }}'{% if not loop.last %},{% endif %}{% endfor %}];
const rawData = [{% for stat in giornaliere_stats %}{{ stat[1] }}{% if not loop.last %},{% endif %}{% endfor %}];

// Formatta le date in formato DD/MM
const formattedLabels = rawDates.map(dateStr => {
    const [anno, mese, giorno] = dateStr.split('-');
    return `${giorno}/${mese}`;
});

new Chart(giornaliereCtx, {
    type: 'line',
    data: {
        labels: formattedLabels,
        datasets: [{
            label: 'Numero di Persone',
            data: rawData,
            borderColor: '#FFD700',
            backgroundColor: 'rgba(255, 215, 0, 0.15)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#FFD700',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: '#FFA500',
            pointHoverBorderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
            mode: 'index'
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    color: '#fff',
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    padding: 15,
                    usePointStyle: true
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#FFD700',
                bodyColor: '#fff',
                borderColor: '#FFD700',
                borderWidth: 1,
                padding: 12,
                displayColors: true,
                callbacks: {
                    title: function(context) {
                        const dataIndex = context[0].dataIndex;
                        const fullDate = rawDates[dataIndex];
                        const [anno, mese, giorno] = fullDate.split('-');
                        const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                                     'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                        return `${giorno} ${mesi[parseInt(mese) - 1]} ${anno}`;
                    },
                    label: function(context) {
                        return `Persone: ${context.parsed.y}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Numero di Persone',
                    color: '#fff',
                    font: {
                        size: 13,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                },
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    },
                    stepSize: 1,
                    precision: 0
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.15)',
                    lineWidth: 1
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Data',
                    color: '#fff',
                    font: {
                        size: 13,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                },
                ticks: {
                    color: '#fff',
                    font: {
                        size: 10
                    },
                    maxRotation: 45,
                    minRotation: 0
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    display: true
                }
            }
        }
    }
});
{% endif %}

// Page transition
document.body.classList.add('page-transition');

// Smooth chart animations
document.addEventListener('DOMContentLoaded', function() {
    const charts = document.querySelectorAll('canvas');
    charts.forEach((chart, index) => {
        chart.style.opacity = '0';
        chart.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            chart.style.opacity = '1';
        }, index * 200);
    });
});

// Enhanced Toast System
function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    if (!container) {
        const newContainer = document.createElement('div');
        newContainer.id = 'toast-container';
        document.body.appendChild(newContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '',
        error: '',
        info: '',
        warning: ''
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    if ('vibrate' in navigator) {
        navigator.vibrate(type === 'success' ? [10, 50, 10] : [20, 50, 20]);
    }
    
    setTimeout(() => {
        toast.style.animation = 'toastSlideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}
</script>
</body>
</html>

